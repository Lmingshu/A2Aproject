<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>A2A ç›¸äº² â€” æœˆè€åŠ ç­ä¸­</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
  <style>
/* ============================================================
   å…¨å±€å˜é‡ä¸é‡ç½®ï¼ˆæ¸©é¦¨æ˜äº®ç‰ˆï¼‰
============================================================ */
:root{
  --bg:#fff9f7; /* æµ…æš–ç™½ */
  --bg2:#fff0eb; /* ç•¥æ·±çš„æš–è‰²èƒŒæ™¯ */
  --surface:#ffffff;
  --surface2:#fdf2f4; /* è£…é¥°æ€§æµ…ç²‰åº•è‰² */
  --border:rgba(225,29,72,.08); /* ææ·¡çš„çº¢è‰²è¾¹æ¡† */
  --pink:#f43f5e;
  --rose:#e11d48; /* ä¸»è‰²çº¢ */
  --gold:#f59e0b;
  --cyan:#06b6d4;
  --green:#10b981;
  --purple:#8b5cf6;
  --text:#4a4543; /* æ·±è¤ç°ï¼ŒæŸ”å’Œæ­£æ–‡ */
  --text2:#78716c; /* æ¬¡çº§ç° */
  --text3:#a8a29e; /* æµ…ç° */
  --r:16px;
  --r-lg:24px;
  --r-xl:32px;
  --shadow:0 4px 20px rgba(225,29,72,.06), 0 1px 4px rgba(0,0,0,.02);
  --glow-pink:0 8px 32px rgba(244,63,94,.15);
  --glow-gold:0 8px 32px rgba(245,158,11,.15);
  --tr:all .3s cubic-bezier(.4,0,.2,1);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Noto Sans SC',-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
  background-image:radial-gradient(circle at 50% 0%, #fff1f2 0%, var(--bg) 60%);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
}
a{color:inherit;text-decoration:none}
button{font-family:inherit;cursor:pointer}
img{display:block;max-width:100%}

/* ============================================================
   é¡µé¢åˆ‡æ¢
============================================================ */
.page{display:none;min-height:100vh;max-width:720px;margin:0 auto;padding:32px 20px 60px}
.page.active{display:block;animation:pageIn .5s cubic-bezier(.34,1.56,.64,1)}
@keyframes pageIn{from{opacity:0;transform:translateY(24px) scale(.96)}to{opacity:1;transform:none}}

/* ============================================================
   å…¨å±€ Loader & Toast
============================================================ */
#loader{position:fixed;inset:0;background:rgba(255,249,247,.92);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:9999;flex-direction:column;gap:16px}
#loader.show{display:flex}
.spin{width:44px;height:44px;border:4px solid var(--surface2);border-top-color:var(--rose);border-radius:50%;animation:spin .8s cubic-bezier(.5,0,.5,1) infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loader-text{font-size:.95rem;color:var(--text2);font-weight:500;letter-spacing:.02em}

#toasts{position:fixed;top:24px;right:24px;z-index:10001;display:flex;flex-direction:column;gap:12px;pointer-events:none}
.toast{
  pointer-events:auto;padding:14px 20px;
  background:var(--surface);border-radius:var(--r);
  box-shadow:0 8px 32px rgba(0,0,0,.08);
  font-size:.9rem;color:var(--text);font-weight:500;
  animation:toastIn .4s cubic-bezier(.34,1.56,.64,1);
  display:flex;align-items:center;gap:12px;
  border-left:4px solid transparent
}
.toast.ok{border-left-color:var(--green)}
.toast.err{border-left-color:var(--rose)}
.toast .dot{display:none} /* ç®€åŒ– */
@keyframes toastIn{from{opacity:0;transform:translateX(60px)}}

/* ============================================================
   é€šç”¨ç»„ä»¶
============================================================ */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:8px;
  padding:14px 28px;border:none;border-radius:var(--r);
  font-size:1rem;font-weight:700;transition:var(--tr);
  position:relative;overflow:hidden
}
/* çº¢è‰²ä¸»æŒ‰é’®ï¼šæ¸å˜çº¢ç²‰ */
.btn-primary{
  background:linear-gradient(135deg,var(--rose),var(--pink));
  color:#fff;
  box-shadow:0 4px 16px rgba(225,29,72,.25)
}
.btn-primary:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 24px rgba(225,29,72,.35)
}
.btn-primary:active{transform:scale(.98)}

/* é‡‘è‰²æŒ‰é’® */
.btn-gold{
  background:linear-gradient(135deg,#f59e0b,#fbbf24);
  color:#fff;
  box-shadow:0 4px 16px rgba(245,158,11,.25)
}
.btn-gold:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 24px rgba(245,158,11,.35)
}

/* æè¾¹æŒ‰é’® */
.btn-outline{
  background:var(--surface);border:2px solid var(--bg2);color:var(--text2)
}
.btn-outline:hover{
  border-color:var(--rose);color:var(--rose);background:var(--surface2)
}

/* å¹½çµæŒ‰é’®ï¼ˆè¿”å›ç­‰ï¼‰ */
.btn-ghost{
  background:transparent;border:none;color:var(--text2);padding:10px 18px;font-size:.9rem;font-weight:500
}
.btn-ghost:hover{background:var(--bg2);color:var(--text)}

/* ç»¿è‰²æˆåŠŸæŒ‰é’® */
.btn-green{
  background:linear-gradient(135deg,#10b981,#34d399);color:#fff;
  box-shadow:0 4px 16px rgba(16,185,129,.25)
}
.btn-green:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(16,185,129,.35)}

/* å¡ç‰‡å®¹å™¨ */
.card{
  background:var(--surface);border-radius:var(--r-lg);padding:24px;
  box-shadow:var(--shadow);border:1px solid var(--bg2);
  transition:var(--tr)
}
.card:hover{
  box-shadow:0 12px 40px rgba(225,29,72,.08);transform:translateY(-2px);border-color:var(--surface2)
}

/* æ ‡ç­¾ Badge */
.badge{display:inline-block;padding:4px 12px;border-radius:999px;font-size:.75rem;font-weight:700;letter-spacing:.02em}
.badge-pink{background:#fff1f2;color:var(--rose)}
.badge-gold{background:#fffbeb;color:var(--gold)}
.badge-green{background:#ecfdf5;color:var(--green)}
.badge-purple{background:#f5f3ff;color:var(--purple)}

.section-title{font-size:1.1rem;font-weight:800;color:var(--text);margin-bottom:16px;display:flex;align-items:center;gap:8px}

/* ============================================================
   1. é¦–é¡µ â€” æœˆè€åŠ ç­ä¸­
============================================================ */
.home{text-align:center;display:flex;flex-direction:column;align-items:center}
.home-badge{margin-bottom:20px}
.home-title{font-size:2.4rem;font-weight:900;line-height:1.2;margin-bottom:12px;color:var(--text)}
.home-title .grad{
  background:linear-gradient(135deg,var(--rose) 0%,var(--gold) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text
}
.home-sub{font-size:1.05rem;color:var(--text2);margin-bottom:40px;font-weight:500}

/* æœˆè€åœºæ™¯ */
.yuelao-scene{position:relative;width:100%;max-width:420px;margin:0 auto 40px;min-height:340px}
.yuelao-desk{display:flex;align-items:flex-end;justify-content:center;min-height:260px;position:relative}
.yuelao-img{
  width:200px;height:auto;max-height:240px;object-fit:contain;
  filter:drop-shadow(0 12px 24px rgba(225,29,72,.1));
  animation:float 4s ease-in-out infinite;
  position:relative;z-index:2
}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
/* çº¢çº¿å›¢å…‰æ™• */
.yarn-pile{
  position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
  width:220px;height:60px;
  background:radial-gradient(ellipse,rgba(244,63,94,.15) 0%,transparent 70%);
  border-radius:50%;z-index:1
}

/* æ°”æ³¡ - ç™½åº•çº¢æ¡†æ›´æ¸…æ™° */
.scene-bubbles{position:absolute;inset:0;pointer-events:none;z-index:3}
.sb{
  position:absolute;background:#fff;
  border:2px solid var(--bg2);border-radius:16px;
  padding:12px 18px;font-size:.9rem;font-weight:600;color:var(--text);
  white-space:nowrap;opacity:0;
  box-shadow:0 4px 16px rgba(0,0,0,.05);
  animation:sbPop .5s cubic-bezier(.34,1.56,.64,1) forwards
}
.sb::after{content:'';position:absolute;width:10px;height:10px;background:#fff;border-bottom:2px solid var(--bg2);border-right:2px solid var(--bg2);transform:rotate(45deg)}

.sb-1{top:20px;left:0;animation-delay:.2s}
.sb-1::after{bottom:-6px;left:24px}
.sb-2{top:60px;right:-10px;animation-delay:.4s}
.sb-2::after{bottom:-6px;right:24px}
.sb-3{bottom:80px;left:-10px;animation-delay:.6s}
.sb-3::after{top:50%;right:-6px;transform:translateY(-50%) rotate(-45deg)}
/* ç¬¬å››ä¸ªæ°”æ³¡é‡‘è‰²å¼ºè°ƒ */
.sb-4{
  bottom:30px;right:-10px;
  background:#fffbeb;border-color:#fde68a;color:var(--gold);
  animation-delay:.8s
}
.sb-4::after{background:#fffbeb;border-color:#fde68a;top:50%;left:-6px;transform:translateY(-50%) rotate(135deg)}

@keyframes sbPop{from{opacity:0;transform:scale(.5) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}

.home .btn-primary{padding:20px 64px;font-size:1.2rem;border-radius:99px;margin-bottom:16px}
.sync-hint{font-size:.9rem;color:var(--text3);margin-top:8px}
.sync-hint.syncing{color:var(--rose);font-weight:600}
.home-skip{margin-top:32px}
.home-skip a{font-size:.9rem;color:var(--text2);border-bottom:1px dashed var(--text3);padding-bottom:2px}
.home-skip a:hover{color:var(--rose);border-color:var(--rose)}

/* ============================================================
   2. ä¸ªäººæ¡£æ¡ˆé¡µ â€” åˆ†èº«ç¡®è®¤
============================================================ */
.profile-header{text-align:center;margin-bottom:32px}
.profile-header h2{font-size:1.5rem;font-weight:800;color:var(--text)}
.profile-header p{font-size:.95rem;color:var(--text2);margin-top:6px}

.profile-grid{display:grid;grid-template-columns:1fr 1.5fr;gap:24px;align-items:start}
@media(max-width:600px){.profile-grid{grid-template-columns:1fr}}

.avatar-card{text-align:center;padding:32px 24px}
.avatar-card .avatar-circle{
  width:140px;height:140px;margin:0 auto 20px;border-radius:50%;
  background:linear-gradient(145deg,#fff0f2,#fff);
  display:flex;align-items:center;justify-content:center;overflow:hidden;
  border:4px solid #fff;box-shadow:0 0 0 2px var(--bg2);
  cursor:pointer;transition:var(--tr);position:relative
}
.avatar-card .avatar-circle:hover{transform:scale(1.05);box-shadow:0 0 0 4px var(--rose)}
.avatar-card .avatar-circle.bixin{animation:bixin .5s ease}
@keyframes bixin{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.avatar-card .avatar-hint{font-size:.85rem;color:var(--text3);font-weight:500}

.attr-card .attr-row{margin-bottom:20px}
.attr-card .attr-label{font-size:.8rem;color:var(--text3);margin-bottom:6px;font-weight:700;letter-spacing:.05em}
.attr-card .attr-value{font-size:1.1rem;font-weight:600;color:var(--text)}

/* æ€§åˆ«é€‰æ‹©æŒ‰é’®ç»„ */
.gender-picker{display:flex;gap:12px;margin-top:4px}
.gender-btn{
  flex:1;padding:12px 0;border:2px solid var(--bg2);border-radius:var(--r);
  background:#fff;font-size:1rem;font-weight:600;cursor:pointer;transition:var(--tr);
  color:var(--text2);text-align:center
}
.gender-btn:hover{border-color:var(--rose);color:var(--rose);background:#fff5f7}
.gender-btn.active[data-gender="male"]{
  border-color:#3b82f6;background:linear-gradient(135deg,#eff6ff,#dbeafe);color:#2563eb;
  box-shadow:0 2px 12px rgba(59,130,246,.15)
}
.gender-btn.active[data-gender="female"]{
  border-color:var(--rose);background:linear-gradient(135deg,#fff5f7,#ffe4ea);color:var(--rose);
  box-shadow:0 2px 12px rgba(244,63,94,.15)
}

.tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.tag{
  padding:6px 16px;background:var(--surface2);color:var(--rose);
  border-radius:999px;font-size:.85rem;font-weight:600;transition:var(--tr)
}
.tag:hover{background:var(--rose);color:#fff}
.family-slots{display:flex;gap:16px;margin-top:12px}
.slot{
  flex:1;height:80px;border:2px dashed var(--bg2);border-radius:var(--r);
  display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:var(--bg2);
  cursor:pointer;transition:var(--tr);background:#fafafa
}
.slot:hover{border-color:var(--rose);color:var(--rose);background:#fff0f2}
.slot.filled{border-style:solid;border-color:var(--green);color:var(--green);background:#ecfdf5}

/* ============================================================
   3. åŒ¹é…å¤§å… â€” ç¼˜åˆ†è¿è¿çœ‹
============================================================ */
.lobby-hero{text-align:center;margin-bottom:32px;padding:20px;background:#fff;border-radius:var(--r-lg);box-shadow:var(--shadow)}
.lobby-hero h2{font-size:1.6rem;font-weight:900;margin-bottom:8px;color:var(--rose)}
.lobby-hero p{font-size:1rem;color:var(--text2)}

.room-input-row{
  display:flex;gap:12px;margin-bottom:28px;align-items:center;
  background:#fff;padding:8px;border-radius:var(--r);border:1px solid var(--bg2);box-shadow:var(--shadow)
}
.room-input-row input{
  flex:1;max-width:120px;padding:12px;border:none;background:var(--bg);border-radius:12px;
  color:var(--text);font-size:1.2rem;font-weight:700;letter-spacing:.1em;text-align:center;
  font-family:inherit;transition:var(--tr)
}
.room-input-row input:focus{outline:none;background:#fff0f2;color:var(--rose)}
.room-input-row .hint{font-size:.85rem;color:var(--text3);flex:1;padding-left:12px}

/* NPC äººç‰©å¡ç‰‡ç½‘æ ¼ */
.npc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;margin-bottom:32px}
.npc-card{
  background:#fff;border:2px solid var(--bg2);border-radius:var(--r-lg);
  padding:0;cursor:pointer;transition:var(--tr);
  position:relative;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.04)
}
.npc-card:hover{transform:translateY(-4px);box-shadow:var(--glow-pink);border-color:rgba(225,29,72,.2)}
.npc-card-body{padding:20px}
.npc-card-top{display:flex;gap:16px;align-items:center;margin-bottom:14px}
.npc-avatar{
  width:64px;height:64px;border-radius:50%;flex-shrink:0;
  background:linear-gradient(145deg,#fff0f2,#fdf2f4);
  display:flex;align-items:center;justify-content:center;overflow:hidden;
  border:3px solid #fff;box-shadow:0 4px 12px rgba(225,29,72,.1);
  font-size:1.8rem
}
.npc-avatar img{width:100%;height:100%;object-fit:cover}
.npc-info{flex:1;min-width:0}
.npc-name{font-size:1.05rem;font-weight:800;color:var(--text);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.npc-desc{font-size:.82rem;color:var(--text2);font-weight:500}
.npc-role-badge{
  position:absolute;top:12px;right:12px;
  padding:3px 10px;border-radius:999px;font-size:.7rem;font-weight:700
}
.npc-role-badge.male{background:#eff6ff;color:#3b82f6}
.npc-role-badge.female{background:#fdf2f8;color:#ec4899}
.npc-tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.npc-tags .ntag{
  padding:4px 10px;background:var(--surface2);color:var(--rose);
  border-radius:999px;font-size:.75rem;font-weight:600
}
.npc-expect{font-size:.82rem;color:var(--text3);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.npc-card-btn{
  display:block;width:100%;padding:14px;border:none;border-top:1px solid var(--bg2);
  background:var(--surface2);color:var(--rose);font-size:.9rem;font-weight:700;
  text-align:center;cursor:pointer;transition:var(--tr)
}
.npc-card-btn:hover{background:var(--rose);color:#fff}

/* çœŸå®ç”¨æˆ·å¡ç‰‡æ ·å¼ï¼ˆåŒºåˆ«äº NPCï¼‰ */
.real-user-card{border-color:rgba(139,92,246,.2);background:linear-gradient(135deg,#faf5ff,#fff)}
.real-user-card:hover{box-shadow:0 8px 32px rgba(139,92,246,.15);border-color:rgba(139,92,246,.3)}
.npc-role-badge.real{background:linear-gradient(135deg,#f5f3ff,#ede9fe);color:var(--purple);font-weight:700}
.real-avatar{border:3px solid var(--purple)!important;box-shadow:0 4px 12px rgba(139,92,246,.15)!important}
.real-user-card .npc-card-btn{background:linear-gradient(135deg,#f5f3ff,#ede9fe);color:var(--purple)}
.real-user-card .npc-card-btn:hover{background:var(--purple);color:#fff}

/* è‡ªåŠ¨åŒ¹é…åŒº - æ›´ç‚«é…· */
.auto-match-card{
  background:linear-gradient(135deg,#fff0f2 0%,#fffbeb 100%);
  border:2px solid rgba(225,29,72,.1);border-radius:var(--r-lg);
  padding:28px 24px;text-align:center;margin-bottom:24px;position:relative;overflow:hidden
}
.auto-match-card::before{
  content:'';position:absolute;top:-30px;right:-30px;width:100px;height:100px;
  background:radial-gradient(circle,rgba(245,158,11,.15),transparent 70%);border-radius:50%
}
.auto-match-card h3{font-size:1.15rem;font-weight:800;color:var(--text);margin-bottom:6px}
.auto-match-card p{font-size:.88rem;color:var(--text2);margin-bottom:18px;line-height:1.6}
.auto-match-card .btn-gold{padding:16px 48px;font-size:1.05rem;border-radius:99px}

/* åŒ¹é…ç»“æœå¼¹çª— */
.match-reveal{
  position:fixed;inset:0;background:rgba(255,249,247,.95);backdrop-filter:blur(8px);
  display:none;align-items:center;justify-content:center;z-index:200;flex-direction:column;gap:20px
}
.match-reveal.show{display:flex}
.match-reveal-box{
  background:#fff;border-radius:var(--r-xl);padding:40px 32px;text-align:center;
  box-shadow:0 20px 60px rgba(225,29,72,.12);max-width:380px;width:90%;
  animation:pageIn .5s cubic-bezier(.34,1.56,.64,1)
}
.match-reveal-avatar{
  width:96px;height:96px;border-radius:50%;margin:0 auto 16px;
  background:linear-gradient(145deg,#fff0f2,#fdf2f4);
  display:flex;align-items:center;justify-content:center;overflow:hidden;
  border:4px solid #fff;box-shadow:0 8px 24px rgba(225,29,72,.15);font-size:2.5rem
}
.match-reveal-avatar img{width:100%;height:100%;object-fit:cover}
.match-reveal-name{font-size:1.3rem;font-weight:900;color:var(--text);margin-bottom:4px}
.match-reveal-desc{font-size:.9rem;color:var(--text2);margin-bottom:8px}
.match-reveal-tags{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:20px}
.match-reveal-tags .ntag{padding:4px 12px;background:var(--surface2);color:var(--rose);border-radius:999px;font-size:.8rem;font-weight:600}
.match-reveal-hint{font-size:.82rem;color:var(--text3);margin-bottom:16px}

/* å…¬å± - æ°”æ³¡æ ·å¼ */
.public-screen{
  margin-top:20px;max-height:160px;overflow-y:auto;padding:16px;
  background:#fff;border-radius:var(--r);box-shadow:inset 0 2px 8px rgba(0,0,0,.02);
  border:1px solid var(--bg2)
}
.public-screen .ps-item{
  padding:8px 12px;margin-bottom:8px;border-radius:12px;
  background:#fafafa;font-size:.85rem;color:var(--text2);
  display:flex;align-items:center;gap:10px
}
.public-screen .ps-item:last-child{margin-bottom:0}
.ps-item .ps-dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0}

/* ============================================================
   4. è™šæ‹Ÿç›¸äº²é—´
============================================================ */
.room-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.room-top h2{font-size:1.2rem;font-weight:800;color:var(--text)}

.room-stage{
  background:#fff;
  border-radius:var(--r-xl);padding:32px 24px;position:relative;overflow:hidden;
  box-shadow:var(--shadow);border:1px solid var(--bg2)
}
/* é¡¶éƒ¨è£…é¥° - æ¸©é¦¨ç¯å…‰ */
.room-stage::before{
  content:'';position:absolute;top:-40px;left:50%;transform:translateX(-50%);width:200px;height:80px;
  background:var(--gold);filter:blur(60px);opacity:.15;pointer-events:none
}

/* Cä½åŒº */
.c-seats{display:flex;justify-content:center;gap:40px;padding:24px 0 32px;position:relative;z-index:1}
.c-seat{text-align:center;width:110px}
.c-seat .c-avatar{
  width:96px;height:96px;border-radius:50%;margin:0 auto 12px;
  background:#fff;
  display:flex;align-items:center;justify-content:center;overflow:hidden;
  border:4px solid #fff;box-shadow:0 8px 24px rgba(0,0,0,.06);
  transition:var(--tr)
}
.c-seat .c-avatar img{width:100%;height:100%;object-fit:cover}
.c-seat .c-name{font-size:.95rem;font-weight:700;color:var(--text)}
.c-seat .c-avatar:hover{transform:scale(1.05);box-shadow:0 12px 32px rgba(225,29,72,.15)}

/* è¿›åº¦ + å¥½æ„Ÿåº¦/å®¹å¿åº¦é¢æ¿ */
.room-status-panel{position:relative;z-index:1;margin:16px auto;max-width:500px;padding:0 16px}
.room-progress{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.room-progress-label{font-size:.78rem;color:var(--text3);font-weight:600;white-space:nowrap}
.room-progress-bar{flex:1;height:6px;background:var(--bg2);border-radius:99px;overflow:hidden}
.room-progress-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--rose));border-radius:99px;transition:width .6s ease}
.room-progress-text{font-size:.78rem;color:var(--text2);font-weight:700;white-space:nowrap}

.room-meters{display:flex;gap:16px}
.meter{flex:1;position:relative}
.meter-header{display:flex;align-items:center;gap:4px;margin-bottom:6px}
.meter-icon{font-size:.9rem}
.meter-label{font-size:.75rem;color:var(--text3);font-weight:600}
.meter-value{margin-left:auto;font-size:.8rem;font-weight:700;font-variant-numeric:tabular-nums}
.meter-love .meter-value{color:var(--rose)}
.meter-tolerate .meter-value{color:#ef4444}
.meter-bar{height:8px;background:var(--bg2);border-radius:99px;overflow:hidden}
.meter-fill{height:100%;border-radius:99px;transition:width .5s ease}
.love-fill{background:linear-gradient(90deg,#fda4af,var(--rose))}
.tolerate-fill{background:linear-gradient(90deg,#fbbf24,#ef4444)}

.meter-btn{
  position:absolute;right:0;top:-2px;width:28px;height:28px;border-radius:50%;
  border:1.5px solid var(--bg2);background:#fff;cursor:pointer;font-size:.7rem;
  display:flex;align-items:center;justify-content:center;transition:var(--tr);
  box-shadow:0 2px 6px rgba(0,0,0,.06);padding:0;line-height:1
}
.meter-btn:hover{transform:scale(1.15);box-shadow:0 3px 12px rgba(0,0,0,.1)}
.meter-btn-love:hover{border-color:var(--rose);background:#fff0f2}
.meter-btn-tolerate:hover{border-color:#ef4444;background:#fef2f2}

.room-notice{text-align:center;font-size:.72rem;color:var(--text3);letter-spacing:.15em;margin:10px 0 2px;opacity:.6}

/* å¥½æ„Ÿåº¦çˆ±å¿ƒç‰¹æ•ˆ */
.love-burst{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999}
.love-burst .heart{
  position:absolute;font-size:2rem;animation:heartFloat 2s ease-out forwards;opacity:0
}
@keyframes heartFloat{
  0%{transform:translateY(0) scale(0);opacity:1}
  50%{opacity:1;transform:translateY(-80px) scale(1.3)}
  100%{transform:translateY(-200px) scale(.6);opacity:0}
}

/* é€€é€€é€€ç‰¹æ•ˆå®¹å™¨ */
.tui-fullscreen{
  position:fixed;top:0;left:0;width:100%;height:100%;z-index:9998;
  background:rgba(239,68,68,.08);display:flex;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .3s
}
.tui-fullscreen.show{opacity:1;pointer-events:auto}
.tui-fullscreen .tui-text{
  font-size:3rem;font-weight:900;color:#ef4444;
  animation:tuiShake .15s infinite alternate;text-shadow:0 4px 20px rgba(239,68,68,.3)
}
@keyframes tuiShake{
  from{transform:translateX(-4px) rotate(-2deg)}
  to{transform:translateX(4px) rotate(2deg)}
}
/* é•¿è¾ˆåŒº */
.elders{display:flex;justify-content:space-between;margin-top:28px;padding:0 12px;position:relative;z-index:1}
.elder-side{display:flex;gap:12px}
.elder-card{
  width:88px;text-align:center;padding:12px 8px;
  background:#fff;border-radius:var(--r);
  box-shadow:0 4px 12px rgba(0,0,0,.04);transition:var(--tr)
}
.elder-card:hover{transform:translateY(-4px)}
.elder-head{width:56px;height:56px;border-radius:50%;background:var(--bg);margin:0 auto 8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.elder-head img{width:100%;height:100%;object-fit:cover}
.elder-status{font-size:.7rem;color:var(--text2);margin-top:4px;font-weight:600}

/* èŠå¤©è®°å½• - å¯¹è¯æ³¡é£æ ¼ */
.chat-log{
  max-height:400px;overflow-y:auto;margin-top:24px;padding:16px;
  background:#fafafa;border-radius:var(--r);font-size:.95rem;position:relative;z-index:1;
  border:1px solid var(--bg2)
}
.chat-log .msg{
  margin-bottom:12px;padding:12px 16px;background:#fff;border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,.03);animation:msgIn .3s ease;
  line-height:1.6
}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}}
.chat-log .msg strong{color:var(--rose);font-weight:700;margin-right:4px}
.typing-cursor{display:inline-block;width:2px;height:1em;background:var(--rose);margin-left:2px;vertical-align:-2px;animation:blink .7s step-end infinite}
@keyframes blink{50%{opacity:0}}

/* é€€é€€é€€å¼¹çª— */
/* (æ—§ tui-popup å·²ç§»é™¤ï¼Œæ–°ç‰¹æ•ˆä½¿ç”¨ .love-burst å’Œ .tui-fullscreen) */

/* ============================================================
   5. ç»“ç®—é¡µ â€” æ¸¸æˆé€šå…³
============================================================ */
.result{text-align:center;padding-top:48px}
.result h2{font-size:1.8rem;font-weight:900;margin-bottom:12px;color:var(--text)}
.result-desc{color:var(--text2);margin-bottom:48px;font-size:1.05rem}

.result-choices{display:flex;gap:24px;justify-content:center;flex-wrap:wrap;max-width:520px;margin:0 auto 40px}
.result-choices .btn{flex:1;min-width:200px;padding:24px 20px;font-size:1.1rem;border-radius:var(--r-lg)}

.result-feedback{
  display:none;margin:28px auto 0;max-width:440px;padding:40px;text-align:center;
  background:#fff;border-radius:var(--r-xl);box-shadow:var(--shadow);
  animation:pageIn .4s ease
}
.result-feedback.show{display:block}
.result-feedback .rf-img{
  width:100px;height:100px;margin:0 auto 24px;object-fit:contain;
  animation:rfBounce .6s cubic-bezier(.34,1.56,.64,1)
}
@keyframes rfBounce{0%{transform:scale(0) rotate(-180deg)}100%{transform:scale(1) rotate(0)}}
.result-feedback p{font-size:1.1rem;line-height:1.7;color:var(--text);font-weight:500}

/* ============================================================
   æ»šåŠ¨æ¡ç¾åŒ–
============================================================ */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#e5e7eb;border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#d1d5db}

  </style>
</head>
<body>

<!-- Loader -->
<div id="loader"><div class="spin"></div><div class="loader-text">æœˆè€æ­£åœ¨ç‰µçº¿...</div></div>
<!-- Toasts -->
<div id="toasts"></div>

<!-- ========== 1. é¦–é¡µ ========== -->
<div class="page home" id="page-home">
  <div class="home-badge"><span class="badge badge-pink">æœˆè€åŠ ç­ä¸­ ğŸŒ™</span></div>
  <h1 class="home-title"><span class="grad">A2A ç›¸äº²</span></h1>
  <p class="home-sub">è¿‡å¹´å›å®¶ï¼Œç›¸äº²ä¸å°´å°¬ â€” è®© AI å…ˆèŠï¼Œç¼˜åˆ†å¤©æ³¨å®š</p>

  <div class="yuelao-scene">
    <div class="scene-bubbles">
      <div class="sb sb-1">å¹´åº•äº†ï¼Œæœˆè€ä¹Ÿè¦å†²KPI</div>
      <div class="sb sb-2">ç‰µå®Œä½ çš„ç‰µä½ çš„</div>
      <div class="sb sb-3">æœˆè€æ­£åœ¨ç»™çº¢çº¿æ‰“æ­»ç»“...</div>
      <div class="sb sb-4">å‰é¢è¿˜æœ‰ 10086 ä½æ­£åœ¨ç–¯ç‹‚è¿çº¿ä¸­</div>
    </div>
    <div class="yuelao-desk">
      <div class="yarn-pile"></div>
      <img class="yuelao-img" id="yuelao-img" src="images/yuelao.png" alt="æœˆè€"
           onerror="this.src='images/avatar-default.png'; this.onerror=null;" />
    </div>
  </div>

  <a href="#" id="btn-secondme-login" class="btn btn-primary" onclick="return false;">ä½¿ç”¨ SecondMe æˆæƒç™»å½•</a>
  <p class="sync-hint" id="sync-hint">ç™»å½•åå°†åŒæ­¥ï¼šåˆ†èº«ã€èŒä¸šã€å…´è¶£ã€MBTI...</p>
</div>

<!-- ========== 2. ä¸ªäººæ¡£æ¡ˆé¡µ ========== -->
<div class="page" id="page-profile">
  <button type="button" class="btn btn-ghost" id="btn-back-from-profile">â† è¿”å›é¦–é¡µ</button>
  <div class="profile-header">
    <h2>åˆ†èº«ç¡®è®¤</h2>
    <p>ç¡®è®¤ä½ çš„ AI åˆ†èº«æ¡£æ¡ˆï¼Œç„¶åè¿›å…¥åŒ¹é…å¤§å…</p>
  </div>
  <div class="profile-grid">
    <div class="card avatar-card">
      <div class="avatar-circle" id="my-avatar" title="ç‚¹å‡»æ¯”å¿ƒ">
        <img src="images/avatar-default.png" alt="" />
      </div>
      <p class="avatar-hint">ç‚¹å‡»å¤´åƒæ¯”å¿ƒ ğŸ’—</p>
    </div>
    <div class="card attr-card">
      <div class="section-title">ğŸ“‹ å±æ€§å¡ç‰‡</div>
      <div class="attr-row">
        <div class="attr-label">æ€§åˆ«</div>
        <div class="gender-picker" id="gender-picker">
          <button type="button" class="gender-btn" data-gender="male">â™‚ ç”·ç”Ÿ</button>
          <button type="button" class="gender-btn" data-gender="female">â™€ å¥³ç”Ÿ</button>
        </div>
        <div style="font-size:.75rem;color:var(--text3);margin-top:6px">è¯·é€‰æ‹©ä½ çš„æ€§åˆ«ï¼ŒAI ä¼šæ ¹æ®æ­¤åŒ¹é…å¼‚æ€§å˜‰å®¾</div>
      </div>
      <div class="attr-row">
        <div class="attr-label">èŒä¸š</div>
        <div class="attr-value" id="attr-job">â€”</div>
      </div>
      <div class="attr-row">
        <div class="attr-label">æ€§æ ¼æ ‡ç­¾</div>
        <div class="tags" id="attr-tags"><span class="tag">å¾…è¡¥å……</span></div>
      </div>
      <div class="attr-row">
        <div class="attr-label">ğŸ’­ æˆ‘çš„ç›¸äº²è¦æ±‚</div>
        <textarea 
          id="attr-expectation" 
          placeholder="ä¾‹å¦‚ï¼šå¸Œæœ›å¯¹æ–¹æœ‰å…±åŒçˆ±å¥½ï¼Œæ€§æ ¼å¼€æœ—ï¼Œèƒ½ç†è§£æˆ‘çš„å·¥ä½œ..."
          style="width:100%;min-height:80px;padding:12px;border:2px solid var(--bg2);border-radius:var(--r);font-size:.9rem;font-family:inherit;resize:vertical;transition:var(--tr);background:#fff"
          onfocus="this.style.borderColor='var(--rose)';this.style.background='#fff0f2'"
          onblur="this.style.borderColor='var(--bg2)';this.style.background='#fff'"
        ></textarea>
        <div style="font-size:.75rem;color:var(--text3);margin-top:6px">å¡«å†™ä½ çš„æ‹©å¶æ ‡å‡†ï¼ŒAI ä¼šæ ¹æ®è¿™ä¸ªæ¥å¸®ä½ èŠå¤©</div>
      </div>
      <div class="attr-row">
        <div class="attr-label">äº²å‹å›¢å¸­ä½</div>
        <div class="family-slots">
          <div class="slot" id="slot1" title="é‚€è¯·çˆ¶æ¯">+</div>
          <div class="slot" id="slot2" title="é‚€è¯·çˆ¶æ¯">+</div>
        </div>
      </div>
      <button type="button" class="btn btn-primary" id="btn-to-lobby" style="width:100%;margin-top:20px">ç¡®è®¤ï¼Œè¿›å…¥åŒ¹é…å¤§å… â†’</button>
    </div>
  </div>
</div>

<!-- ========== 3. åŒ¹é…å¤§å… ========== -->
<div class="page" id="page-lobby">
  <button type="button" class="btn btn-ghost" id="btn-back-from-lobby">â† è¿”å›</button>
  <div class="lobby-hero">
    <h2>ç¼˜åˆ†è¿è¿çœ‹</h2>
    <p>é€‰ä¸€ä½å¿ƒä»ªçš„å¯¹è±¡ï¼Œæˆ–è®©æœˆè€éšæœºç‰µçº¿</p>
  </div>

  <!-- å…¨è‡ªåŠ¨åŒ¹é…åŒº -->
  <div class="auto-match-card">
    <h3>ğŸ¯ æœˆè€éšæœºç‰µçº¿</h3>
    <p>ä¸æƒ³çº ç»“ï¼Ÿè®©æœˆè€ä»å¤§å…é‡Œéšæœºç»™ä½ æŒ‘ä¸€ä¸ªï¼ŒAI åˆ†èº«å…¨ç¨‹è‡ªåŠ¨å¯¹è¯ï¼Œåç­‰ç»“æœå°±è¡Œï¼</p>
    <button type="button" class="btn btn-gold" id="btn-auto-match">âœ¨ å…¨è‡ªåŠ¨ç›¸äº²æ‰˜ç®¡</button>
  </div>

  <!-- æŒ‡å®šæˆ¿é—´å·å…¥å£ -->
  <div class="room-input-row">
    <input type="text" id="room-code" maxlength="4" placeholder="1234" pattern="\d{4}" />
    <button type="button" class="btn btn-primary" id="btn-enter-room">è¿›å…¥æˆ¿é—´</button>
    <span class="hint">æœ‰æˆ¿é—´å·ï¼Ÿç›´æ¥ç¢°å¤´</span>
  </div>

  <!-- NPC äººç‰©å¡ç‰‡åˆ—è¡¨ -->
  <div class="section-title" style="margin-top:8px">ğŸ‘¥ å¤§å…å˜‰å®¾</div>
  <div class="npc-grid" id="npc-grid">
    <div style="text-align:center;padding:40px;color:var(--text3)">åŠ è½½ä¸­...</div>
  </div>

  <!-- å…¬å± -->
  <div class="card">
    <div class="section-title">ğŸ“¢ å¤§å…åŠ¨æ€</div>
    <div class="public-screen" id="public-screen">
      <div class="ps-item"><span class="ps-dot"></span>æ­å–œ Alex å’Œ Luna çš„ AI èŠå¾—ç«çƒ­ï¼</div>
      <div class="ps-item"><span class="ps-dot" style="background:var(--gold)"></span>èµµç”œç”œçš„ AI å› ä¸ºã€Œè±†è…è„‘å’¸ç”œä¹‹äº‰ã€æ€æ¡Œäº†ï¼</div>
      <div class="ps-item"><span class="ps-dot"></span>æ—å°æºªçš„ AI æ­£åœ¨å’Œé™ˆé»˜çš„ AI èŠäººç”Ÿç†æƒ³â€¦</div>
      <div class="ps-item"><span class="ps-dot" style="background:var(--cyan)"></span>ç‹å¤§å£®çš„å®¶é•¿æ»¡æ„åº¦æ‹‰æ»¡ ğŸ‘ğŸ‘ğŸ‘</div>
    </div>
  </div>
</div>

<!-- åŒ¹é…ç»“æœå¼¹çª— -->
<div class="match-reveal" id="match-reveal">
  <div class="match-reveal-box">
    <div class="match-reveal-avatar" id="mr-avatar">ğŸ’˜</div>
    <div class="match-reveal-name" id="mr-name">åŒ¹é…ä¸­...</div>
    <div class="match-reveal-desc" id="mr-desc"></div>
    <div class="match-reveal-tags" id="mr-tags"></div>
    <div class="match-reveal-hint">æœˆè€å·²å®‰æ’å¥½ç›¸äº²é—´ï¼ŒAI æ­£åœ¨å¼€å§‹å¯¹è¯...</div>
    <button type="button" class="btn btn-primary" id="mr-go" style="width:100%;border-radius:99px">è¿›å…¥ç›¸äº²é—´ â†’</button>
  </div>
</div>

<!-- ========== 4. è™šæ‹Ÿç›¸äº²é—´ ========== -->
<div class="page" id="page-room">
  <div class="room-top">
    <button type="button" class="btn btn-ghost" id="btn-exit-room">â† é€€å‡ºæˆ¿é—´</button>
    <h2>è™šæ‹Ÿç›¸äº²é—´</h2>
    <span style="width:100px"></span>
  </div>

  <div class="room-stage">
    <div class="c-seats">
      <div class="c-seat">
        <div class="c-avatar" id="room-male"><img src="images/avatar-male.png" alt="" /></div>
        <div class="c-name" id="room-male-name">ç”·æ–¹</div>
      </div>
      <div class="c-seat">
        <div class="c-avatar" id="room-female"><img src="images/avatar-female.png" alt="" /></div>
        <div class="c-name" id="room-female-name">å¥³æ–¹</div>
      </div>
    </div>

    <!-- è¿›åº¦ + å¥½æ„Ÿåº¦/å®¹å¿åº¦é¢æ¿ -->
    <div class="room-status-panel">
      <div class="room-progress">
        <span class="room-progress-label">å¯¹è¯è¿›åº¦</span>
        <div class="room-progress-bar"><div class="room-progress-fill" id="room-progress-fill" style="width:0%"></div></div>
        <span class="room-progress-text" id="room-progress-text">0 / 6 è½®</span>
      </div>
      <div class="room-meters">
        <div class="meter meter-love">
          <div class="meter-header">
            <span class="meter-icon">ğŸ’—</span>
            <span class="meter-label">å¥½æ„Ÿåº¦</span>
            <span class="meter-value" id="love-value">0%</span>
          </div>
          <div class="meter-bar"><div class="meter-fill love-fill" id="love-fill" style="width:0%"></div></div>
          <button type="button" class="meter-btn meter-btn-love" id="btn-love-boost" title="æ‰‹åŠ¨å¢åŠ å¥½æ„Ÿåº¦">+ğŸ’—</button>
        </div>
        <div class="meter meter-tolerate">
          <div class="meter-header">
            <span class="meter-icon">ğŸ’¢</span>
            <span class="meter-label">å®¹å¿åº¦</span>
            <span class="meter-value" id="tolerate-value">0%</span>
          </div>
          <div class="meter-bar"><div class="meter-fill tolerate-fill" id="tolerate-fill" style="width:0%"></div></div>
          <button type="button" class="meter-btn meter-btn-tolerate" id="btn-tolerate-boost" title="æ‰‹åŠ¨å¢åŠ å®¹å¿åº¦">+ğŸ’¢</button>
        </div>
      </div>
    </div>

    <div class="room-notice">è™šæ‹Ÿç›¸äº² Â· éè¯šå‹¿æ‰°</div>

    <div style="text-align:center;margin-top:4px">
      <button type="button" class="btn btn-ghost" id="btn-exit-room-bottom">â† é€€å‡ºæˆ¿é—´</button>
    </div>

    <div class="elders">
      <div class="elder-side">
        <div class="elder-card">
          <div class="elder-head"><img src="images/parent-family.png" alt="" /></div>
          <div class="elder-status badge badge-green" style="font-size:.65rem">æ»¡æ„åº¦ ğŸ‘Ã—4</div>
        </div>
      </div>
      <div class="elder-side">
        <div class="elder-card">
          <div class="elder-head"><img src="images/parent-family.png" alt="" /></div>
          <div class="elder-status badge badge-gold" style="font-size:.65rem">æ­£åœ¨ç»„ç»‡è¯­è¨€</div>
        </div>
      </div>
    </div>

    <div class="chat-log" id="chat-log-room"></div>
  </div>

  <!-- å¥½æ„Ÿåº¦æ»¡çˆ±å¿ƒç‰¹æ•ˆ -->
  <div class="love-burst" id="love-burst"></div>
  <!-- å®¹å¿åº¦æ»¡é€€é€€é€€ç‰¹æ•ˆ -->
  <div class="tui-fullscreen" id="tui-fullscreen">
    <div class="tui-text">ğŸ™… é€€ï¼é€€ï¼é€€ï¼ğŸ™…</div>
  </div>
</div>

<!-- ========== 5. è¯„ä»·ä¸ç»“ç®— ========== -->
<div class="page result" id="page-result">
  <button type="button" class="btn btn-ghost" id="btn-back-from-result" style="display:block;margin:0 auto 16px">â† è¿”å›å¤§å…</button>
  <h2>ç›¸äº²ç»“ç®—</h2>
  <p style="color:var(--text2);margin-bottom:32px;font-size:.95rem" class="result-desc">æœ¬æ¬¡ç›¸äº²å·²ç»“æŸï¼Œè¯·åšå‡ºä½ çš„é€‰æ‹©</p>
  <div class="result-choices">
    <button type="button" class="btn btn-green" id="btn-result-ok">ğŸ’• å¤©ä½œä¹‹åˆï¼Œç‰µæ‰‹æˆåŠŸ</button>
    <button type="button" class="btn btn-outline" id="btn-result-no">ğŸ‘‹ åˆ†èº«ä¸åˆï¼Œæ±Ÿæ¹–å†è§</button>
  </div>
  <div class="result-feedback card" id="result-success">
    <img class="rf-img" src="images/result-success.png" alt="" onerror="this.style.display='none'" />
    <p>ğŸ‰ æ­å–œï¼ç¼˜åˆ†å·²ç‰µå¥½ï¼Œè®°å¾—çº¿ä¸‹è§é¢å“¦ï½<br/>æœˆè€æ­£åœ¨å¾€ä½ çš„çº¢çº¿ä¸Šæ‰“åŒä»½ç»“ï¼</p>
  </div>
  <div class="result-feedback card" id="result-reject">
    <img class="rf-img" src="images/result-bye.png" alt="" onerror="this.style.display='none'" />
    <p>æ²¡å…³ç³»ï¼Œä¸‹ä¸€ä¸ªä¼šæ›´å¥½ï¼<br/>æœˆè€å·²æŠŠçº¢çº¿å›æ”¶åˆ©ç”¨ï¼Œç¯ä¿â™»ï¸</p>
  </div>
</div>

<!-- ========== JavaScript ========== -->
<script>
const API_BASE = '';
let authSessionId = null;
let myProfile = null;
let myGender = 'male'; // é»˜è®¤ç”·æ€§ï¼Œç”¨æˆ·å¯åœ¨æ¡£æ¡ˆé¡µä¿®æ”¹
let currentSessionId = null; // å½“å‰ç›¸äº²ä¼šè¯ ID

/* ---- å·¥å…·å‡½æ•° ---- */
function showLoader(text) {
  const el = document.getElementById('loader');
  if (text) el.querySelector('.loader-text').textContent = text;
  el.classList.add('show');
}
function hideLoader() {
  const el = document.getElementById('loader');
  el.style.opacity = '0';
  setTimeout(() => { el.classList.remove('show'); el.style.opacity = '1'; }, 250);
}
function toast(msg, type) {
  const c = document.getElementById('toasts');
  const t = document.createElement('div');
  t.className = 'toast ' + (type || 'ok');
  // ä½¿ç”¨ textContent é˜²æ­¢ XSSï¼ˆmsg å¯èƒ½æ¥è‡ªåç«¯ error.detailï¼‰
  var dot = document.createElement('span');
  dot.className = 'dot';
  t.appendChild(dot);
  t.appendChild(document.createTextNode(msg));
  c.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateX(60px)'; setTimeout(() => t.remove(), 300); }, 3000);
}
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) {
    el.classList.add('active');
    // ç«‹å³æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œç¡®ä¿æ–°é¡µé¢å†…å®¹ç›´æ¥æ˜¾ç¤ºåœ¨é¡¶éƒ¨å¯è§åŒºåŸŸ
    // ä½¿ç”¨å¤šç§æ–¹å¼ç¡®ä¿æ»šåŠ¨ç”Ÿæ•ˆ
    window.scrollTo(0, 0);
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
    // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM æ›´æ–°åå†æ»šåŠ¨
    requestAnimationFrame(function() {
      window.scrollTo(0, 0);
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
      // å¦‚æœé¡µé¢æœ‰åŠ¨ç”»ï¼Œç­‰å¾…åŠ¨ç”»å®Œæˆåå†ç¡®ä¿æ»šåŠ¨ä½ç½®
      setTimeout(function() {
        window.scrollTo(0, 0);
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
      }, 100);
    });
  }
}
function getLoginUrl() {
  return (API_BASE || '') + '/api/auth/secondme/login?redirect_path=' + encodeURIComponent('/');
}

/* ---- 1. é¦–é¡µ ---- */
document.getElementById('btn-secondme-login').addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  // æ˜¾ç¤ºåŠ è½½æç¤ºï¼ˆçŸ­æš‚æ˜¾ç¤ºï¼‰
  showLoader('æ­£åœ¨è·³è½¬ SecondMe...');
  // ç«‹å³è·³è½¬ï¼Œç¡®ä¿çœŸæ­£çš„é¡µé¢è·³è½¬ï¼ˆä¸æ˜¯å•é¡µåˆ‡æ¢ï¼‰
  setTimeout(function() {
    window.location.href = getLoginUrl();
  }, 100); // çŸ­æš‚å»¶è¿Ÿç¡®ä¿åŠ è½½å™¨æ˜¾ç¤º
});
/* æœªç™»å½•ä¸èƒ½è¿›å…¥å¤§å…ï¼ˆå·²ç§»é™¤"å…ˆé€›é€›"å…¥å£ï¼‰ */

/* ---- é¡µé¢åˆå§‹åŒ–ï¼šåªåœ¨é¦–æ¬¡è®¿é—®ä¸”æœªç™»å½•æ—¶æ˜¾ç¤ºé¦–é¡µ ---- */
(function initPage() {
  const params = new URLSearchParams(window.location.search);
  const session = params.get('session');
  const error = params.get('error');
  
  // åªåœ¨ä»¥ä¸‹æƒ…å†µæ˜¾ç¤ºé¦–é¡µï¼š
  // 1. æ²¡æœ‰ç™»å½•å›è°ƒå‚æ•°ï¼ˆsession/errorï¼‰
  // 2. æ²¡æœ‰å·²ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆmyProfileï¼‰
  // 3. å½“å‰æ²¡æœ‰æ´»åŠ¨é¡µé¢ï¼ˆæ‰€æœ‰é¡µé¢éƒ½éšè—ï¼‰
  if (!session && !error) {
    setTimeout(function() {
      const hasActivePage = document.querySelector('.page.active');
      if (!hasActivePage && !myProfile) {
        showPage('page-home');
      }
    }, 0);
  }
})();

/* ---- 2. ç™»å½•å›è°ƒ ---- */
(function initAuth() {
  const params = new URLSearchParams(window.location.search);
  const session = params.get('session');
  const error = params.get('error');
  const hint = document.getElementById('sync-hint');
  
  // å¦‚æœæœ‰ session å‚æ•°ï¼Œè¯´æ˜æ˜¯ä»ç™»å½•å›è°ƒå›æ¥çš„ï¼Œéœ€è¦å¼ºåˆ¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  if (session) {
    showLoader('æ­£åœ¨åŒæ­¥ä½ çš„åˆ†èº«ä¿¡æ¯...');
    // ä¸å¼ºåˆ¶æ˜¾ç¤ºé¦–é¡µï¼Œä¿æŒå½“å‰é¡µé¢çŠ¶æ€ï¼ˆåŠ è½½å™¨ä¼šè¦†ç›–ï¼‰
  }
  
  if (error) {
    hideLoader();
    // é”™è¯¯æ—¶ï¼Œåªåœ¨æ²¡æœ‰æ´»åŠ¨é¡µé¢æ—¶æ‰æ˜¾ç¤ºé¦–é¡µ
    const hasActivePage = document.querySelector('.page.active');
    if (!hasActivePage) {
      showPage('page-home');
    }
    if (hint) hint.textContent = 'ç™»å½•å¤±è´¥ï¼š' + (error === 'missing_code' ? 'æœªæ”¶åˆ°æˆæƒç ' : error === 'token_failed' ? 'Token äº¤æ¢å¤±è´¥' : error === 'no_token' ? 'æœªè·å–åˆ° Token' : error);
    return;
  }
  
  const doFetch = (sid) => {
    if (sid) authSessionId = sid;
    if (hint && session) { 
      hint.textContent = 'æ­£åœ¨æŠ“å–ä½ çš„åˆ†èº«ã€èŒä¸šã€å…´è¶£ã€MBTI...'; 
      hint.classList.add('syncing'); 
    }
    var url = API_BASE + '/api/auth/me';
    if (sid) url += '?session_id=' + encodeURIComponent(sid);
    fetch(url, { credentials: 'include' })
      .then(r => {
        if (!r.ok) {
          throw new Error('HTTP ' + r.status);
        }
        return r.json();
      })
      .then(data => {
        if (data.logged_in && data.profile) {
          myProfile = data;
          if (hint) hint.textContent = 'åŒæ­¥å®Œæˆï¼';
          fillProfilePage(data);
          hideLoader();
          
          // æ¸…ç† URL å‚æ•°ï¼Œé¿å…åˆ·æ–°æ—¶é‡å¤å¤„ç†
          if (params.has('session') || params.has('error')) {
            try { 
              window.history.replaceState({}, '', window.location.pathname || '/'); 
            } catch(_) {}
          }
          
          // ç™»å½•æˆåŠŸåï¼Œç«‹å³åˆ‡æ¢åˆ°æ¡£æ¡ˆé¡µ
          showPage('page-profile');
          // ç¡®ä¿é¡µé¢æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œæ–°é¡µé¢å†…å®¹ç›´æ¥æ˜¾ç¤ºåœ¨é¡¶éƒ¨å¯è§åŒºåŸŸ
          setTimeout(function() {
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            // ç¡®ä¿é¡µé¢å…ƒç´ åœ¨é¡¶éƒ¨å¯è§
            var profilePage = document.getElementById('page-profile');
            if (profilePage) {
              profilePage.scrollIntoView({ behavior: 'instant', block: 'start' });
            }
          }, 100);
          toast('ç™»å½•æˆåŠŸï¼Œåˆ†èº«å·²åŒæ­¥ï¼');
        } else if (hint && session) {
          hideLoader();
          // å¤±è´¥æ—¶ï¼Œåªåœ¨æ²¡æœ‰æ´»åŠ¨é¡µé¢æ—¶æ‰æ˜¾ç¤ºé¦–é¡µ
          const hasActivePage = document.querySelector('.page.active');
          if (!hasActivePage) {
            showPage('page-home');
          }
          hint.textContent = 'åŒæ­¥å¤±è´¥ï¼Œè¯·é‡è¯•'; 
          hint.classList.remove('syncing');
        } else {
          hideLoader();
          // æœªç™»å½•æ—¶ï¼Œåªåœ¨æ²¡æœ‰æ´»åŠ¨é¡µé¢æ—¶æ‰æ˜¾ç¤ºé¦–é¡µ
          if (!session) {
            const hasActivePage = document.querySelector('.page.active');
            if (!hasActivePage) {
              showPage('page-home');
            }
          }
        }
      })
      .catch(function(err) { 
        hideLoader();
        // å¼‚å¸¸æ—¶ï¼Œåªåœ¨æ²¡æœ‰æ´»åŠ¨é¡µé¢æ—¶æ‰æ˜¾ç¤ºé¦–é¡µ
        const hasActivePage = document.querySelector('.page.active');
        if (!hasActivePage) {
          showPage('page-home');
        }
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', err);
        if (hint) { 
          hint.textContent = 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•'; 
          hint.classList.remove('syncing'); 
        }
        if (session) {
          toast('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•', 'err');
        }
      });
  };
  
  if (session) {
    // æœ‰ session å‚æ•°ï¼Œè¯´æ˜æ˜¯ç™»å½•å›è°ƒï¼Œç«‹å³å¤„ç†
    doFetch(session);
  } else {
    // æ²¡æœ‰ sessionï¼Œå¯èƒ½æ˜¯é¦–æ¬¡åŠ è½½ï¼Œæ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    doFetch();
  }
})();

function fillProfilePage(data) {
  const p = data.profile || {};
  const jobEl = document.getElementById('attr-job');
  if (jobEl) jobEl.textContent = p.occupation || 'â€”';
  const tagsEl = document.getElementById('attr-tags');
  if (tagsEl) {
    const tags = (p.hobbies || '').split(/[,ï¼Œã€]/).filter(Boolean).slice(0, 6);
    tagsEl.innerHTML = tags.length ? tags.map(t => '<span class="tag">' + escapeHtml(t.trim()) + '</span>').join('') : '<span class="tag">å¾…è¡¥å……</span>';
  }
  // å¡«å……ç›¸äº²è¦æ±‚
  const expectationEl = document.getElementById('attr-expectation');
  if (expectationEl) {
    expectationEl.value = p.expectation || '';
  }
  const box = document.getElementById('my-avatar');
  if (box) {
    const url = data.avatar_url || p.avatar_url;
    if (url) box.querySelector('img').src = url;
  }
  // å›æ˜¾æ€§åˆ«ï¼ˆå¦‚æœåç«¯è¿”å›äº† gender å­—æ®µï¼‰
  if (data.gender) {
    setGenderSelection(data.gender);
  }
}

/* æ€§åˆ«é€‰æ‹©äº¤äº’ */
function setGenderSelection(gender) {
  myGender = gender;
  document.querySelectorAll('.gender-btn').forEach(function(btn) {
    btn.classList.toggle('active', btn.dataset.gender === gender);
  });
}

document.getElementById('gender-picker').addEventListener('click', function(e) {
  var btn = e.target.closest('.gender-btn');
  if (!btn) return;
  setGenderSelection(btn.dataset.gender);
});

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

/* ---- 3. æ¡£æ¡ˆé¡µäº¤äº’ ---- */
document.getElementById('my-avatar').addEventListener('click', function() {
  this.classList.add('bixin');
  setTimeout(() => this.classList.remove('bixin'), 500);
});
document.getElementById('btn-to-lobby').addEventListener('click', function() {
  showLoader('æ­£åœ¨è¿›å…¥å¤§å…...');
  // è¿›å…¥å¤§å…å‰ï¼Œé€šçŸ¥åç«¯æ›´æ–°ç”¨æˆ·çš„æ€§åˆ«
  if (authSessionId) {
    fetch(API_BASE + '/api/dating/lobby/update-gender', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: authSessionId, gender: myGender })
    })
    .then(function(r) { return r.json(); })
    .then(function() { showPage('page-lobby'); fetchLobby(); hideLoader(); })
    .catch(function() { showPage('page-lobby'); fetchLobby(); hideLoader(); });
  } else {
    setTimeout(function() { showPage('page-lobby'); fetchLobby(); hideLoader(); }, 300);
  }
});
document.getElementById('btn-back-from-profile').addEventListener('click', () => showPage('page-home'));
document.getElementById('btn-back-from-lobby').addEventListener('click', () => showPage(myProfile ? 'page-profile' : 'page-home'));
document.getElementById('btn-back-from-result').addEventListener('click', () => { showPage('page-lobby'); fetchLobby(); });
document.getElementById('slot1').addEventListener('click', function() { this.classList.toggle('filled'); this.textContent = this.classList.contains('filled') ? 'âœ“ å·²é‚€è¯·' : '+'; });
document.getElementById('slot2').addEventListener('click', function() { this.classList.toggle('filled'); this.textContent = this.classList.contains('filled') ? 'âœ“ å·²é‚€è¯·' : '+'; });

/* ---- 4. å¤§å… â€”â€” ä» API åŠ è½½ NPC åˆ—è¡¨ ---- */
var lobbyNpcs = [];
var defaultAvatars = { male: 'ğŸ§‘', female: 'ğŸ‘©' };

function escapeAttr(s) { return String(s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

function renderNpcGrid() {
  var el = document.getElementById('npc-grid');
  if (!el) return;
  // è¿‡æ»¤ï¼šåªæ˜¾ç¤ºå¼‚æ€§å˜‰å®¾ï¼Œæ’é™¤è‡ªå·±
  var oppositeGender = (myGender === 'male') ? 'female' : 'male';
  var filtered = lobbyNpcs.filter(function(n) {
    // æ’é™¤è‡ªå·±ï¼ˆé€šè¿‡ user_ å‰ç¼€ + userId åŒ¹é…ï¼‰
    if (n.id && n.id.indexOf('user_') === 0 && authSessionId) {
      // çœŸå®ç”¨æˆ·å¡ç‰‡ä¸éœ€è¦æ’é™¤ï¼ˆæˆ‘ä»¬æ— æ³•ç²¾ç¡®åˆ¤æ–­ user_id ä¸ session_id çš„å¯¹åº”å…³ç³»ï¼‰
      // ä½†åŒæ€§åˆ«çš„ä¸€å¾‹æ’é™¤
    }
    return n.role === oppositeGender;
  });
  if (!filtered.length) {
    el.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text3)">æš‚æ— å¼‚æ€§å˜‰å®¾ï¼Œè¯·ç¨åå†æ¥</div>';
    return;
  }
  // å°†çœŸå®ç”¨æˆ·æ’åœ¨å‰é¢ï¼ŒNPC åœ¨åé¢
  var sorted = filtered.slice().sort(function(a, b) {
    if (a.is_real_user && !b.is_real_user) return -1;
    if (!a.is_real_user && b.is_real_user) return 1;
    return 0;
  });
  el.innerHTML = sorted.map(function(n, i) {
    var hobbies = (n.hobbies||'').split(/[,ï¼Œã€]/).filter(Boolean).slice(0,4);
    var isReal = n.is_real_user;
    var avatarHtml = n.avatar_url
      ? '<img src="' + escapeAttr(n.avatar_url) + '" alt="" onerror="this.style.display=\'none\';this.parentNode.textContent=\'' + (n.role==='male'?'ğŸ§‘':'ğŸ‘©') + '\'" />'
      : (n.role === 'male' ? 'ğŸ§‘' : 'ğŸ‘©');
    var tagHtml = hobbies.map(function(t){ return '<span class="ntag">' + escapeAttr(t.trim()) + '</span>'; }).join('');
    // çœŸå®ç”¨æˆ·æœ‰ç‰¹æ®Šæ ·å¼æ ‡è®°
    var cardClass = 'npc-card' + (isReal ? ' real-user-card' : '');
    var badgeText = isReal
      ? 'âœ¨ SecondMe ç”¨æˆ·'
      : (n.role==='male'?'â™‚ ç”·å˜‰å®¾':'â™€ å¥³å˜‰å®¾');
    var badgeClass = isReal ? 'npc-role-badge real' : ('npc-role-badge ' + n.role);
    return '<div class="' + cardClass + '" data-npc-id="' + escapeAttr(n.id) + '" style="animation:pageIn .35s ease '+(i*.06)+'s both">' +
      '<span class="' + badgeClass + '">' + badgeText + '</span>' +
      '<div class="npc-card-body">' +
        '<div class="npc-card-top">' +
          '<div class="npc-avatar' + (isReal ? ' real-avatar' : '') + '">' + avatarHtml + '</div>' +
          '<div class="npc-info"><div class="npc-name">' + escapeAttr(n.display_name) + '</div>' +
          '<div class="npc-desc">' + escapeAttr(n.desc || (n.age ? n.age+'å² Â· ' : '') + (n.occupation||'')) + '</div></div>' +
        '</div>' +
        '<div class="npc-tags">' + tagHtml + '</div>' +
        (n.expectation ? '<div class="npc-expect">ğŸ’¬ ' + escapeAttr(n.expectation) + '</div>' : '') +
      '</div>' +
      '<div class="npc-card-btn">' + (isReal ? 'å’Œ TA çš„åˆ†èº«èŠèŠ â†’' : 'é€‰ TA ç›¸äº² â†’') + '</div>' +
    '</div>';
  }).join('');

  el.querySelectorAll('.npc-card').forEach(function(card) {
    card.addEventListener('click', function() {
      var npcId = this.dataset.npcId;
      var npc = lobbyNpcs.find(function(n){ return n.id === npcId; });
      if (npc) startMatchWithNpc(npc);
    });
  });
}

function fetchLobby() {
  fetch(API_BASE + '/api/dating/lobby')
    .then(function(r){ 
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json(); 
    })
    .then(function(d){
      lobbyNpcs = d.users || [];
      renderNpcGrid();
    })
    .catch(function(err){ 
      console.error('åŠ è½½å¤§å…å¤±è´¥:', err);
      toast('åŠ è½½å¤§å…å¤±è´¥ï¼š' + (err.message || 'ç½‘ç»œå¼‚å¸¸'), 'err'); 
    });
}

/* é€‰æ‹©æŒ‡å®š NPC ç›¸äº² */
function startMatchWithNpc(npc) {
  showLoader('æœˆè€æ­£åœ¨å®‰æ’ç›¸äº²é—´...');
  var payload = buildSessionPayload();
  // æ ¹æ® NPC æ€§åˆ«è®¾ç½®å¯¹æ‰‹æ¡£æ¡ˆï¼ˆå¡«å…¥å¯¹æ‰‹ä¾§ï¼‰
  var npcInfo = { display_name: npc.display_name, occupation: npc.occupation||'', hobbies: npc.hobbies||'', extra: npc.extra||'', expectation: npc.expectation||'' };
  if (npc.role === 'female') {
    payload.female = npcInfo;
  } else {
    payload.male = npcInfo;
  }
  payload.target_user_id = npc.id;
  fetch(API_BASE + '/api/dating/sessions', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) })
    .then(function(r){ 
      if (!r.ok) {
        return r.json().then(function(err){ throw new Error(err.detail || 'HTTP ' + r.status); });
      }
      return r.json(); 
    })
    .then(function(d){
      hideLoader();
      enterRoom(d.session_id, payload);
    })
    .catch(function(err){ 
      hideLoader(); 
      console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', err);
      toast('åˆ›å»ºå¤±è´¥ï¼š'+(err.message||'ç½‘ç»œå¼‚å¸¸'), 'err'); 
    });
}

/* å…¨è‡ªåŠ¨éšæœºåŒ¹é… */
document.getElementById('btn-auto-match').addEventListener('click', function() {
  showLoader('æœˆè€æ­£åœ¨ç¿»çº¢çº¿ç°¿...');
  var payload = buildSessionPayload();
  fetch(API_BASE + '/api/dating/auto-match', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) })
    .then(function(r){ 
      if (!r.ok) {
        return r.json().then(function(err){ throw new Error(err.detail || 'HTTP ' + r.status); });
      }
      return r.json(); 
    })
    .then(function(d){
      hideLoader();
      // å±•ç¤ºåŒ¹é…ç»“æœå¼¹çª—
      var npc = d.matched_npc || {};
      if (!npc.display_name) {
        toast('åŒ¹é…æˆåŠŸï¼Œä½†æœªè·å–åˆ°å¯¹æ–¹ä¿¡æ¯', 'err');
        return;
      }
      showMatchReveal(npc, d.session_id, payload);
    })
    .catch(function(err){ 
      hideLoader(); 
      console.error('è‡ªåŠ¨åŒ¹é…å¤±è´¥:', err);
      toast('åŒ¹é…å¤±è´¥ï¼š'+(err.message||'æš‚æ— åˆé€‚å¯¹è±¡'), 'err'); 
    });
});

function showMatchReveal(npc, sessionId, payload) {
  var reveal = document.getElementById('match-reveal');
  var avatarEl = document.getElementById('mr-avatar');
  var nameEl = document.getElementById('mr-name');
  var descEl = document.getElementById('mr-desc');
  var tagsEl = document.getElementById('mr-tags');
  nameEl.textContent = npc.display_name || 'ç¥ç§˜å˜‰å®¾';
  descEl.textContent = (npc.age ? npc.age+'å² Â· ' : '') + (npc.occupation || '');
  var hobbies = (npc.hobbies||'').split(/[,ï¼Œã€]/).filter(Boolean).slice(0,5);
  tagsEl.innerHTML = hobbies.map(function(t){ return '<span class="ntag">' + escapeAttr(t.trim()) + '</span>'; }).join('');
  if (npc.avatar_url) {
    avatarEl.innerHTML = '<img src="' + escapeAttr(npc.avatar_url) + '" alt="" style="width:100%;height:100%;object-fit:cover" />';
  } else {
    avatarEl.textContent = npc.role === 'male' ? 'ğŸ§‘' : 'ğŸ’˜';
  }
  reveal.classList.add('show');
  // "è¿›å…¥ç›¸äº²é—´" æŒ‰é’®
  var goBtn = document.getElementById('mr-go');
  goBtn.onclick = function() {
    reveal.classList.remove('show');
    enterRoom(sessionId, payload, npc);
  };
}

/* æˆ¿é—´å·å…¥å£ */
document.getElementById('btn-enter-room').addEventListener('click', function() {
  var code = (document.getElementById('room-code').value || '').trim();
  if (!/^\d{4}$/.test(code)) { toast('è¯·è¾“å…¥ 4 ä½æ•°å­—æˆ¿é—´å·', 'err'); return; }
  createManualSession(code);
});

function createManualSession(roomCode) {
  showLoader('æœˆè€æ­£åœ¨åˆ†é…çº¢çº¿...');
  var payload = buildSessionPayload();
  fetch(API_BASE + '/api/dating/sessions', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) })
    .then(function(r){ 
      if (!r.ok) {
        return r.json().then(function(err){ throw new Error(err.detail || 'HTTP ' + r.status); });
      }
      return r.json(); 
    })
    .then(function(d){
      hideLoader();
      enterRoom(d.session_id, payload);
    })
    .catch(function(err){ 
      hideLoader(); 
      console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', err);
      toast('åˆ›å»ºå¤±è´¥ï¼š'+(err.message||'ç½‘ç»œå¼‚å¸¸'), 'err'); 
    });
}

/* é€šç”¨ï¼šæ„å»º session payload */
function buildSessionPayload() {
  // è·å–ç”¨æˆ·è¾“å…¥çš„ç›¸äº²è¦æ±‚
  var expectationEl = document.getElementById('attr-expectation');
  var userExpectation = expectationEl ? (expectationEl.value || '').trim() : '';
  var isMale = (myGender === 'male');

  var myInfo = myProfile && myProfile.profile
    ? { 
        display_name: myProfile.name || myProfile.profile.display_name, 
        occupation: myProfile.profile.occupation||'', 
        hobbies: myProfile.profile.hobbies||'', 
        extra: myProfile.profile.extra||'',
        expectation: userExpectation || myProfile.profile.expectation || ''
      }
    : { display_name: 'æˆ‘', expectation: userExpectation };

  var p = {
    male: isMale ? myInfo : { display_name: 'ç”·æ–¹' },
    female: isMale ? { display_name: 'å¥³æ–¹' } : myInfo,
    male_parent: { display_name: isMale ? 'æˆ‘çš„å®¶é•¿' : 'ç”·æ–¹å®¶é•¿' },
    female_parent: { display_name: isMale ? 'å¥³æ–¹å®¶é•¿' : 'æˆ‘çš„å®¶é•¿' },
    max_rounds: 6,
    user_gender: myGender  // å‘ŠçŸ¥åç«¯ç”¨æˆ·é€‰æ‹©çš„æ€§åˆ«
  };

  // æ ¹æ®æ€§åˆ«è®¾ç½® SecondMe session id
  if (authSessionId) {
    if (isMale) {
      p.secondme_male_session_id = authSessionId;
    } else {
      p.secondme_female_session_id = authSessionId;
    }
  }
  return p;
}

/* é€šç”¨ï¼šè¿›å…¥ç›¸äº²é—´ */
function enterRoom(sessionId, payload, matchedNpc) {
  currentSessionId = sessionId; // ä¿å­˜å½“å‰ä¼šè¯ ID
  resetRoomMeters(); // é‡ç½®å¥½æ„Ÿåº¦/å®¹å¿åº¦/è¿›åº¦
  showPage('page-room');
  var isMale = (myGender === 'male');
  var myName = isMale
    ? ((payload.male && payload.male.display_name) || 'æˆ‘')
    : ((payload.female && payload.female.display_name) || 'æˆ‘');
  var otherName = matchedNpc ? matchedNpc.display_name
    : (isMale ? ((payload.female && payload.female.display_name) || 'å¯¹æ–¹')
              : ((payload.male && payload.male.display_name) || 'å¯¹æ–¹'));
  document.getElementById('room-male-name').textContent = isMale ? myName : otherName;
  document.getElementById('room-female-name').textContent = isMale ? otherName : myName;

  // æ›´æ–°ç›¸äº²é—´å¤´åƒ
  try {
    var myAvatarEl = document.getElementById(isMale ? 'room-male' : 'room-female');
    var otherAvatarEl = document.getElementById(isMale ? 'room-female' : 'room-male');
    if (myProfile && (myProfile.avatar_url || (myProfile.profile && myProfile.profile.avatar_url))) {
      var myUrl = myProfile.avatar_url || myProfile.profile.avatar_url;
      if (myUrl && myAvatarEl) myAvatarEl.querySelector('img').src = myUrl;
    }
    if (matchedNpc && matchedNpc.avatar_url && otherAvatarEl) {
      otherAvatarEl.querySelector('img').src = matchedNpc.avatar_url;
    }
  } catch(_) {}

  startRoomEvents(sessionId);
  toast('ç›¸äº²é—´å·²å°±ç»ªï¼ŒAI æ­£åœ¨çƒ­åœº...');
}

/* ---- 5. ç›¸äº²é—´äº‹ä»¶ ---- */
function startRoomEvents(sessionId, opts) {
  opts = opts || {};
  const logEl = document.getElementById('chat-log-room');
  if (!logEl) return;
  // ä»…é¦–æ¬¡è¿›å…¥æ—¶æ¸…ç©ºèŠå¤©è®°å½•ï¼ˆé‡è¿æ—¶ä¿ç•™å·²æœ‰æ¶ˆæ¯ï¼‰
  if (!opts.isReconnect) logEl.innerHTML = '';
  // å…³é—­æ—§è¿æ¥
  if (window._currentEvt) { try { window._currentEvt.close(); } catch(_) {} }
  var eventQueue = [], isTyping = false, currentEvt = null;
  window._sseIntentionalClose = false; // æ ‡è®°ä¸»åŠ¨å…³é—­ï¼Œé˜²æ­¢ onerror è§¦å‘é‡è¿
  function scrollToBottom() { logEl.scrollTop = logEl.scrollHeight; }
  function typeInto(container, text, opts, done) {
    opts = opts || {};
    var baseSpeed = opts.speed || 85;
    var textLength = text.length;
    var dynamicSpeed = textLength < 20 ? baseSpeed * 0.9 : (textLength > 50 ? baseSpeed * 1.1 : baseSpeed);
    var chunk = opts.chunk || 1, idx = 0;
    var cursor = document.createElement('span');
    cursor.className = 'typing-cursor';
    container.appendChild(cursor);
    (function tick() {
      if (idx >= text.length) { cursor.remove(); done(); return; }
      var end = Math.min(idx + chunk, text.length);
      container.insertBefore(document.createTextNode(text.slice(idx, end)), cursor);
      idx = end; scrollToBottom();
      var delay = dynamicSpeed;
      if (idx > 0 && text[idx - 1] && /[ï¼Œã€‚ï¼ï¼Ÿã€]/.test(text[idx - 1])) {
        delay = dynamicSpeed * 1.3;
      }
      setTimeout(tick, delay);
    })();
  }
  function processQueue() {
    if (isTyping || !eventQueue.length) return;
    var item = eventQueue.shift();
    var wrap = document.createElement('div');
    wrap.className = 'msg';
    if (item.type === 'round_start') {
      wrap.innerHTML = '<strong>ã€ç¬¬' + item.round + 'è½®ã€‘</strong> ';
      logEl.appendChild(wrap);
      var sp = document.createElement('span'); wrap.appendChild(sp);
      isTyping = true;
      typeInto(sp, item.goal || '', { speed: 75 }, () => { isTyping = false; scrollToBottom(); processQueue(); });
    } else if (item.type === 'message') {
      var thinkTime = 500 + Math.random() * 500;
      wrap.innerHTML = '<strong>' + escapeHtml(item.display_name || item.role || '') + 'ï¼š</strong> ';
      logEl.appendChild(wrap);
      isTyping = true;
      setTimeout(function() {
        var sp = document.createElement('span'); wrap.appendChild(sp);
        typeInto(sp, item.content || '', { speed: 85 }, () => { isTyping = false; scrollToBottom(); processQueue(); });
      }, thinkTime);
    } else if (item.type === 'summary') {
      wrap.style.cssText = 'background:rgba(251,191,36,.08);border-color:rgba(251,191,36,.2)';
      wrap.innerHTML = 'ğŸ“‹ ';
      var sp = document.createElement('span'); wrap.appendChild(sp);
      logEl.appendChild(wrap);
      isTyping = true;
      typeInto(sp, item.summary_text || '', { speed: 95 }, () => {
        isTyping = false; scrollToBottom();
        // æ ‡è®°ä¸»åŠ¨å…³é—­ï¼Œé˜»æ­¢ onerror è§¦å‘é‡è¿
        window._sseIntentionalClose = true;
        if (currentEvt) currentEvt.close();
        setTimeout(() => showPage('page-result'), 1200);
      });
    }
  }

  // å…ˆå»ºç«‹ SSE è¿æ¥ï¼Œè¿æ¥æˆåŠŸåå†å¯åŠ¨ä¼šè¯ï¼ˆé¿å…ç«æ€ä¸¢å¤±åˆå§‹äº‹ä»¶ï¼‰
  currentEvt = new EventSource(API_BASE + '/api/dating/sessions/' + sessionId + '/events');
  window._currentEvt = currentEvt;

  currentEvt.onopen = function() {
    // SSE è¿æ¥å·²å»ºç«‹ï¼Œç°åœ¨å®‰å…¨åœ°å¯åŠ¨ä¼šè¯
    fetch(API_BASE + '/api/dating/sessions/' + sessionId + '/start', { method: 'POST' })
      .catch(function(err) { console.warn('å¯åŠ¨ä¼šè¯å¤±è´¥ï¼ˆå¯èƒ½å·²å¯åŠ¨ï¼‰:', err); });
  };

  currentEvt.onerror = function(e) {
    // å¦‚æœæ˜¯ä¸»åŠ¨å…³é—­ï¼ˆå¦‚ summary åæˆ–é€€å‡ºæˆ¿é—´ï¼‰ï¼Œä¸åšä»»ä½•å¤„ç†
    if (window._sseIntentionalClose) return;
    console.error('EventSource é”™è¯¯:', e);
    if (currentEvt.readyState === EventSource.CLOSED) {
      toast('è¿æ¥å·²æ–­å¼€', 'err');
      // ä»…å°è¯•ä¸€æ¬¡é‡è¿ï¼Œé¿å…æ— é™å¾ªç¯
      setTimeout(function() {
        if (!window._sseIntentionalClose && currentEvt.readyState === EventSource.CLOSED) {
          toast('æ­£åœ¨é‡æ–°è¿æ¥...', 'ok');
          startRoomEvents(sessionId, { isReconnect: true });
        }
      }, 3000);
    }
  };

  currentEvt.onmessage = function(e) {
    try {
      var data = JSON.parse(e.data);
      if (data.type === 'heartbeat') return;
      
      if (data.type === 'round_start') {
        eventQueue.push({ type: 'round_start', round: data.round, goal: data.goal || '' });
        // æ›´æ–°è¿›åº¦ï¼ˆåç«¯ä¼šä¼  max_roundsï¼‰
        if (data.max_rounds) roomMaxRounds = data.max_rounds;
        updateProgress(data.round || 1, roomMaxRounds);
      } else if (data.type === 'message') {
        eventQueue.push({ 
          type: 'message', 
          display_name: data.display_name || '', 
          role: data.role || '', 
          content: data.content || '' 
        });
        // æ ¹æ®æ¶ˆæ¯å†…å®¹åŠ¨æ€è°ƒæ•´å¥½æ„Ÿåº¦/å®¹å¿åº¦ï¼ˆæ¨¡æ‹Ÿæƒ…æ„Ÿå˜åŒ–ï¼‰
        var content = (data.content || '').toLowerCase();
        var loveKeywords = ['å–œæ¬¢', 'æœ‰è¶£', 'å“ˆå“ˆ', 'å¤ªå·§äº†', 'ä¸€æ ·', 'å¥½æ„Ÿ', 'ä¸é”™', 'æŒºå¥½', 'å¼€å¿ƒ', 'æœŸå¾…', 'å…±åŒ', 'å¿—åŒé“åˆ', 'æ¬£èµ', 'ä¼˜ç§€', 'æ¸©æŸ”', 'å¯çˆ±'];
        var annoyKeywords = ['ä¸å¤ª', 'ç®—äº†', 'è¿˜å¥½å§', 'ä¸€èˆ¬', 'ä¸åˆé€‚', 'åˆ†æ­§', 'ä¸åŒæ„', 'å‘µå‘µ', 'å°´å°¬', 'æ— è¯­', 'ç¦»è°±'];
        var loveHit = loveKeywords.some(function(k){ return content.indexOf(k) >= 0; });
        var annoyHit = annoyKeywords.some(function(k){ return content.indexOf(k) >= 0; });
        // å¥½æ„Ÿåº¦ï¼šæ¯æ¡æ¶ˆæ¯åŸºç¡€å¢åŠ  1-3%ï¼Œæ­£é¢å…³é”®è¯é¢å¤– +2-4%ï¼Œè´Ÿé¢å…³é”®è¯å‡å°‘
        // è®¾è®¡ç›®æ ‡ï¼š4è½®å¯¹è¯ï¼ˆçº¦16æ¡æ¶ˆæ¯ï¼‰è‡ªç„¶è¾¾åˆ° 60-80%ï¼Œä¸ä¼šè½»æ˜“è‡ªåŠ¨æ»¡
        var baseLove = 1 + Math.random() * 2;
        if (loveHit) baseLove += 2 + Math.random() * 2;
        if (annoyHit) baseLove = Math.max(0, baseLove - 2);
        updateMeter('love', roomLove + baseLove);
        // å®¹å¿åº¦ï¼šå¢é•¿æ›´æ…¢ï¼Œæ¯æ¡æ¶ˆæ¯ 0-1%ï¼Œè´Ÿé¢å…³é”®è¯é¢å¤– +3-6%
        var baseTolerate = Math.random() * 1;
        if (annoyHit) baseTolerate += 3 + Math.random() * 3;
        updateMeter('tolerate', roomTolerate + baseTolerate);
      } else if (data.type === 'summary') {
        eventQueue.push({ type: 'summary', summary_text: data.summary_text || '' });
        // æ€»ç»“æ—¶è¿›åº¦æ‹‰æ»¡
        updateProgress(roomMaxRounds, roomMaxRounds);
      } else {
        console.warn('æœªçŸ¥ SSE äº‹ä»¶ç±»å‹:', data.type);
      }
      processQueue();
    } catch (err) {
      console.error('è§£æ SSE æ¶ˆæ¯å¤±è´¥:', err, e.data);
    }
  };
}

/* ---- 6. å¥½æ„Ÿåº¦ / å®¹å¿åº¦ç³»ç»Ÿ ---- */
var roomLove = 0, roomTolerate = 0, roomMaxRounds = 6, roomCurrentRound = 0;
var loveTriggered = false, tolerateTriggered = false;

function updateMeter(type, value) {
  value = Math.max(0, Math.min(100, Math.round(value)));
  if (type === 'love') {
    roomLove = value;
    var fill = document.getElementById('love-fill');
    var txt = document.getElementById('love-value');
    if (fill) fill.style.width = value + '%';
    if (txt) txt.textContent = value + '%';
    // å¥½æ„Ÿåº¦ 100% è§¦å‘çˆ±å¿ƒç‰¹æ•ˆ
    if (value >= 100 && !loveTriggered) {
      loveTriggered = true;
      triggerLoveBurst();
      toast('å¥½æ„Ÿåº¦çˆ†è¡¨ï¼çœ‹èµ·æ¥å¾ˆèˆ¬é…');
    }
  } else {
    roomTolerate = value;
    var fill = document.getElementById('tolerate-fill');
    var txt = document.getElementById('tolerate-value');
    if (fill) fill.style.width = value + '%';
    if (txt) txt.textContent = value + '%';
    // å®¹å¿åº¦ 100% è§¦å‘é€€é€€é€€ç‰¹æ•ˆ
    if (value >= 100 && !tolerateTriggered) {
      tolerateTriggered = true;
      triggerTuiEffect();
      toast('å®¹å¿åº¦çˆ†è¡¨ï¼çœ‹ä¸ä¸‹å»äº†...');
    }
  }
}

function updateProgress(current, max) {
  roomCurrentRound = current;
  roomMaxRounds = max || 6;
  var pct = Math.round((current / roomMaxRounds) * 100);
  var fill = document.getElementById('room-progress-fill');
  var txt = document.getElementById('room-progress-text');
  if (fill) fill.style.width = pct + '%';
  if (txt) txt.textContent = current + ' / ' + roomMaxRounds + ' è½®';
}

function triggerLoveBurst() {
  var container = document.getElementById('love-burst');
  if (!container) return;
  var hearts = ['ğŸ’—', 'ğŸ’•', 'â¤ï¸', 'ğŸ’–', 'ğŸ’˜', 'ğŸ¥°', 'ğŸ˜'];
  for (var i = 0; i < 20; i++) {
    (function(idx) {
      setTimeout(function() {
        var h = document.createElement('span');
        h.className = 'heart';
        h.textContent = hearts[Math.floor(Math.random() * hearts.length)];
        h.style.left = (10 + Math.random() * 80) + '%';
        h.style.top = (40 + Math.random() * 40) + '%';
        h.style.fontSize = (1.2 + Math.random() * 2) + 'rem';
        h.style.animationDelay = (Math.random() * 0.3) + 's';
        container.appendChild(h);
        setTimeout(function() { h.remove(); }, 2500);
      }, idx * 100);
    })(i);
  }
}

function triggerTuiEffect() {
  var el = document.getElementById('tui-fullscreen');
  if (!el) return;
  el.classList.add('show');
  setTimeout(function() { el.classList.remove('show'); }, 2500);
}

function resetRoomMeters() {
  roomLove = 0; roomTolerate = 0; roomCurrentRound = 0;
  loveTriggered = false; tolerateTriggered = false;
  updateMeter('love', 0);
  updateMeter('tolerate', 0);
  updateProgress(0, roomMaxRounds);
}

// æ‰‹åŠ¨å¢åŠ å¥½æ„Ÿåº¦
document.getElementById('btn-love-boost').addEventListener('click', function() {
  updateMeter('love', 100);
  this.style.transform = 'scale(1.3)';
  setTimeout(() => { this.style.transform = ''; }, 300);
});

// æ‰‹åŠ¨å¢åŠ å®¹å¿åº¦
document.getElementById('btn-tolerate-boost').addEventListener('click', function() {
  updateMeter('tolerate', 100);
  this.style.transform = 'scale(1.3)';
  setTimeout(() => { this.style.transform = ''; }, 300);
});
function exitRoom() {
  window._sseIntentionalClose = true; // é˜»æ­¢ onerror é‡è¿
  if (window._currentEvt) { try { window._currentEvt.close(); } catch(_) {} window._currentEvt = null; }
  showLoader('æ­£åœ¨é€€å‡º...');
  setTimeout(() => { showPage('page-lobby'); fetchLobby(); hideLoader(); toast('å·²é€€å‡ºç›¸äº²é—´'); }, 300);
}
document.getElementById('btn-exit-room').addEventListener('click', exitRoom);
document.getElementById('btn-exit-room-bottom').addEventListener('click', exitRoom);

/* ---- 7. ç»“ç®— ---- */
document.getElementById('btn-result-ok').addEventListener('click', function() {
  document.getElementById('result-success').classList.add('show');
  document.getElementById('result-reject').classList.remove('show');
  toast('æ­å–œç‰µæ‰‹æˆåŠŸï¼ğŸ‰');
});
document.getElementById('btn-result-no').addEventListener('click', function() {
  document.getElementById('result-reject').classList.add('show');
  document.getElementById('result-success').classList.remove('show');
  toast('æ²¡å…³ç³»ï¼Œä¸‹ä¸€ä¸ªæ›´å¥½ï¼');
});
</script>
</body>
</html>
